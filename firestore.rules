
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ЁЯСС Admin ржЪрж┐ржирзЗ рж░рж╛ржЦрж╛рж░ ржЬржирзНржп ржПржХржЯрж╛ helper ржлрж╛ржВрж╢ржи
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.email == "shahmubaruk05@gmail.com" ||  // рждрзЛржорж╛рж░ admin ржЗржорзЗржЗрж▓
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2"       // рждрзЛржорж╛рж░ UID (рж╕рзНржХрзНрж░рж┐ржирж╢ржЯрзЗ ржпрзЗржЯрж╛ ржЫрж┐рж▓)
        );
    }

    // ЁЯФР рж╕рж╛ржзрж╛рж░ржг user-ржПрж░ basic access (ржирж┐ржЬрзЗрж░ ржбрзЗржЯрж╛)
    match /users/{userId} {
      // ржирж┐ржЬрзЗрж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ read/update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // sign up ржХрж░рж▓рзЗ create
      allow create: if request.auth != null;
    }

    // ржкрзНрж░рждрзНржпрзЗржХ user-ржПрж░ transactions subcollection
    match /users/{userId}/transactions/{txId} {
      // user рж╢рзБржзрзБ ржирж┐ржЬрзЗрж░ transaction ржЧрзБрж▓рзЛ ржжрзЗржЦрждрзЗ/ржмрж╛ржирж╛рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create: if request.auth != null && request.auth.uid == userId;
      // status change ржЗрждрзНржпрж╛ржжрж┐ рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ржпржжрж┐ root level ржП "transactions" collection ржерж╛ржХрзЗ (ржпрзЗржоржи summary/stats ржПрж░ ржЬржирзНржп)
    match /transactions/{txId} {
      allow read, write: if isAdmin();
    }

    // ЁЯМР ржЕржирзНржп рж╕ржм ржбржХрзБржорзЗржирзНржЯрзЗрж░ ржЬржирзНржп ржбрж┐ржлрж▓рзНржЯ rule:
    // рж╢рзБржзрзБ admin рж╕ржмржХрж┐ржЫрзБ read/write ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
