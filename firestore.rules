rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ‘‘ Admin helper function
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.email == "shahmubaruk05@gmail.com" || // Your admin email
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2"      // Your admin UID
        );
    }

    // ğŸ§‘â€ğŸ’» User profiles
    match /users/{userId} {
      // Any logged-in user can read any user doc
      // (for recipient search by email)
      allow read: if request.auth != null;

      // Any logged-in user can update any user doc
      // (for fund transfers)
      allow update: if request.auth != null;

      // Allow creating a new user doc (during signup)
      allow create: if request.auth != null;
    }

    // ğŸ” Transactions for each user (subcollection)
    match /users/{userId}/transactions/{txId} {
      // User can read and create their own transactions
      allow read, create: if request.auth != null && request.auth.uid == userId;
      // Admin can update/delete for status changes
      allow update, delete: if isAdmin();
    }
    
    // ğŸ›¡ï¸ Collection group rule for all 'transactions'
    match /{path=**}/transactions/{txId} {
        // Admins can list all transactions across all users
        allow list: if isAdmin();
    }

    // ğŸŒ Root-level transactions log (for transfers, admin view, etc.)
    match /transactions/{txId} {
      // Any logged-in user can create a new transaction
      allow create: if request.auth != null;

      // Reading a transaction is allowed if:
      // - The user is an admin
      // - The user is part of the transaction (sender or receiver)
      allow read: if isAdmin() ||
        (request.auth != null && (
          resource.data.userId == request.auth.uid ||
          (resource.data.transferDetails != null && resource.data.transferDetails.senderId == request.auth.uid) ||
          (resource.data.transferDetails != null && resource.data.transferDetails.recipientId == request.auth.uid)
        ));

      // Update/delete only for admins
      allow update, delete: if isAdmin();
    }

    // ğŸ’° Wallet balance data (This seems deprecated in favor of `walletBalance` on the user doc)
    match /userAccounts/{userId} {
      // User can manage their own account
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      // Admin can manage everything
      allow read, write: if isAdmin();
    }

    // ğŸŒ Exchange rates
    match /exchange_rates/{rateId} {
      allow read: if request.auth != null;   // All logged-in users can read
      allow write: if isAdmin();             // Only admins can change
    }

    // ğŸŒ Exchange limits
    match /exchange_limits/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ğŸªª Card applications
    match /card_applications/{userId} {
      // User can manage their own application
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      // Admin can read/write all applications
      allow read, write: if isAdmin();
    }

  }
}
