rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ЁЯСС Admin ржЪрж┐ржирж╛рж░ helper
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.email == "shahmubaruk05@gmail.com" || // рждрзЛржорж╛рж░ admin ржЗржорзЗржЗрж▓
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2"      // admin UID
        );
    }

    // ЁЯФР User profile
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }

    // ЁЯФР ржкрзНрж░рждрж┐ user ржПрж░ transactions (subcollection)
    match /users/{userId}/transactions/{txId} {
      // ржЗржЙржЬрж╛рж░ ржирж┐ржЬрзЗрж░ ржЯрзНрж░рж╛ржирзНрж╕рзНржпрж╛ржХрж╢ржи рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрждрзЗ ржУ рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create: if request.auth != null && request.auth.uid == userId;
      // status change / modify рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ЁЯМН Root-level transactions log (admin dashboard + client create)
    match /transactions/{txId} {
      // ржирждрзБржи transaction create: owner ржмрж╛ admin
      allow create: if request.auth != null &&
        (
          request.resource.data.userId == request.auth.uid || // transaction ржП userId ржлрж┐рж▓рзНржб ржерж╛ржХржмрзЗ
          isAdmin()
        );

      // read: owner ржирж┐ржЬрзЗрж░ржЯрж╛, admin рж╕ржм
      allow read: if isAdmin() ||
        (request.auth != null && resource.data.userId == request.auth.uid);

      // update/delete: рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ЁЯТ░ Wallet balance ржбрж╛ржЯрж╛
    match /userAccounts/{userId} {
      // ржЗржЙржЬрж╛рж░ ржирж┐ржЬрзЗрж░ ржПржХрж╛ржЙржирзНржЯ ржжрзЗржЦрждрзЗ ржУ update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      // admin рж╕ржм manage ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, write: if isAdmin();
    }

    // ЁЯМР Exchange rates
    match /exchange_rates/{rateId} {
      allow read: if request.auth != null;   // рж╕ржм logged-in user ржжрзЗржЦржмрзЗ
      allow write: if isAdmin();             // рж╢рзБржзрзБ admin change ржХрж░ржмрзЗ
    }

    // ЁЯМР Exchange limits
    match /exchange_limits/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ЁЯкк Card applications
    match /card_applications/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // ржбрж┐ржлрж▓рзНржЯ: ржмрж╛ржХрж┐ рж╕ржм ржбржХрзБржорзЗржирзНржЯ рж╢рзБржзрзБ admin
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
