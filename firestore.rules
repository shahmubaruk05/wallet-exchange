rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ЁЯСС Admin ржЪрж┐ржирж╛рж░ helper
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.email == "shahmubaruk05@gmail.com" || // рждрзЛржорж╛рж░ admin ржЗржорзЗржЗрж▓
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2"      // admin UID
        );
    }

    // ЁЯзСтАНЁЯТ╗ User profiles
    match /users/{userId} {
      // ЁЯФУ ржпрзЗ ржХрзЗржЙ logged-in рж╣рж▓рзЗ рж╕ржм user ржбржХ ржкрзЬрждрзЗ ржкрж╛рж░ржмрзЗ
      // (ржЗржорзЗржЗрж▓ ржжрж┐рзЯрзЗ recipient search ржХрж░рж╛рж░ ржЬржирзНржп)
      allow read: if request.auth != null;

      // ржирж┐ржЬрзЗрж░ ржбржХ ржЖржкржбрзЗржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow update: if request.auth != null && request.auth.uid == userId;

      // ржирждрзБржи user ржбржХ create (signup ржПрж░ рж╕ржорзЯ)
      allow create: if request.auth != null;
    }

    // ЁЯФР ржкрзНрж░рждрж┐ user ржПрж░ transactions (subcollection)
    match /users/{userId}/transactions/{txId} {
      // ржЗржЙржЬрж╛рж░ ржирж┐ржЬрзЗрж░ ржЯрзНрж░рж╛ржирзНрж╕рзНржпрж╛ржХрж╢ржи рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрждрзЗ ржУ рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create: if request.auth != null && request.auth.uid == userId;
      // status change / modify рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ЁЯМН Root-level transactions log (transfer history)
    match /transactions/{txId} {
      // ржпрзЗ ржХрзЛржирзЛ logged-in user ржирждрзБржи transaction create ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow create: if request.auth != null;

      // transaction ржкрзЬрж╛ ржпрж╛ржмрзЗ:
      // - admin рж╕ржм ржжрзЗржЦрждрзЗ ржкрж╛рж░ржмрзЗ
      // - рж╕рж╛ржзрж╛рж░ржг user рж╢рзБржзрзБ ржирж┐ржЬрзЗрж░ржЯрж╛ (ржпржжрж┐ userId, fromUserId, senderId ржПрж░ ржпрзЗржХрзЛржирзЛржЯрж╛рждрзЗ ржерж╛ржХрзЗ)
      allow read: if isAdmin() ||
        (request.auth != null && (
          resource.data.userId == request.auth.uid ||
          resource.data.fromUserId == request.auth.uid ||
          resource.data.senderId == request.auth.uid
        ));

      // update/delete: рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ЁЯТ░ Wallet balance ржбрж╛ржЯрж╛
    match /userAccounts/{userId} {
      // ржЗржЙржЬрж╛рж░ ржирж┐ржЬрзЗрж░ ржПржХрж╛ржЙржирзНржЯ ржжрзЗржЦрждрзЗ ржУ update ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      // admin рж╕ржм manage ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, write: if isAdmin();
    }

    // ЁЯМР Exchange rates
    match /exchange_rates/{rateId} {
      allow read: if request.auth != null;   // рж╕ржм logged-in user ржжрзЗржЦржмрзЗ
      allow write: if isAdmin();             // рж╢рзБржзрзБ admin change ржХрж░ржмрзЗ
    }

    // ЁЯМР Exchange limits
    match /exchange_limits/{docId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ЁЯкк Card applications
    match /card_applications/{userId} {
      allow read, create, update: if request.auth != null && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // ржбрж┐ржлрж▓рзНржЯ: ржмрж╛ржХрж┐ рж╕ржм ржбржХрзБржорзЗржирзНржЯ рж╢рзБржзрзБ admin
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
