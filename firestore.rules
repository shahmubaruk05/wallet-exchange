
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Check if the user is signed in and if their user document has role == 'admin'
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Secure user profiles.
    match /users/{userId} {
      // An authenticated user can read/write their own document.
      // An admin can read/write any user document.
      allow read, write: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      // An admin can list/query users.
      allow list, get: if isAdmin();
    }

    // Secure transactions for each user.
    match /users/{userId}/transactions/{transactionId} {
        // A user can create a transaction for themselves.
        allow create: if isSignedIn() && request.auth.uid == userId && request.resource.data.userId == userId;
        // A user can read/update their own transactions.
        // An admin can read/update any transaction.
        allow read, update, delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
        // A user can list their own transactions. An admin can also list.
        allow list: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
    }
    
    // Allow admins to perform collection group queries on 'transactions'.
    match /{path=**}/transactions/{transactionId} {
      allow list, get: if isAdmin();
    }

    // Secure exchange rates.
    match /exchange_rates/{exchangeRateId} {
      // Any signed-in user can read rates.
      allow read: if isSignedIn();
      // Only admins can write rates.
      allow write: if isAdmin();
    }

    // Secure card applications. The document ID is the user's UID.
    match /card_applications/{userId} {
      // User can create, read, and update their own application.
      allow create, read, update: if isSignedIn() && request.auth.uid == userId;
      // Admins can read and update any application.
      allow read, update, list: if isAdmin();
    }

    // Secure exchange limits.
    match /exchange_limits/{limitId} {
      // Any signed-in user can read limits.
      allow read: if isSignedIn();
      // Only admins can write limits.
      allow write: if isAdmin();
    }
     match /{path=**}/users/{userId} {
      allow list, get: if isAdmin();
    }
  }
}
