
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
        (
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2" ||   // তোমার UID
          request.auth.token.email == "shahmubaruk05@gmail.com"   // তোমার ইমেইল
        );
    }

    // ---------- USERS ----------
    match /users/{userId} {
      // লগইন করা যে কেউ সব user ডক পড়তে পারবে (recipient search না থাকলেও harmless)
      allow read: if isSignedIn();

      // নিজে নিজের প্রোফাইল update করতে পারবে
      // + admin সব user update করতে পারবে (walletBalance সহ)
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||    // নিজে
        isAdmin()                        // admin
      );

      // signup এর সময় create
      allow create: if isSignedIn();
    }

    // ---------- ROOT TRANSACTIONS ----------
    // এখানে EXCHANGE / ADD FUNDS transaction লগ থাকে
    match /transactions/{txId} {

      // ইউজার নিজের transaction create করবে (Exchange রিকোয়েস্ট)
      // ডকে অবশ্যই userId == auth.uid থাকতে হবে
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;

      // ইউজার নিজের transaction গুলো দেখতে পারবে, admin সব দেখতে পারবে
      allow read: if
        isAdmin() ||
        (
          isSignedIn() &&
          resource.data.userId == request.auth.uid
        );

      // status, adminNote ইত্যাদি update: শুধু admin
      allow update: if isAdmin();
    }

    // ---------- USER SUBCOLLECTION: transactions ----------
    // কিছু কোড user-wise history রাখলে এর প্রয়োজন হবে
    match /users/{userId}/transactions/{txId} {
      // user নিজের ডক create করে (mirror log)
      allow create: if isSignedIn() && request.auth.uid == userId;

      // user নিজের history পড়তে পারবে, admin সব
      allow read: if isAdmin() || (
        isSignedIn() && request.auth.uid == userId
      );

      // status sync / edit: শুধু admin
      allow update: if isAdmin();
    }

    // ---------- Exchange rates ----------
    match /exchange_rates/{rateId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ---------- Exchange limits ----------
    match /exchange_limits/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ---------- Card applications ----------
    match /card_applications/{userId} {
      allow read, create, update: if isSignedIn() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

  }
}
