
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ЁЯСС Admin ржЪрж┐ржирж╛рж░ helper
    function isAdmin() {
      return request.auth != null &&
        (
          request.auth.token.email == "shahmubaruk05@gmail.com" || // admin email
          request.auth.uid == "FD7Eh00D9ObTUmvfJ8ybAvbUn6h2"      // admin UID
        );
    }

    // ЁЯФР User profile
    match /users/{userId} {
      // ржирж┐ржЬрзЗрж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржжрзЗржЦрж╛ / ржЖржкржбрзЗржЯ
      allow read, update: if request.auth != null && request.auth.uid == userId;
      // рж╕рж╛ржЗржи ржЖржк ржПрж░ рж╕ржорзЯ create
      allow create: if request.auth != null;
    }

    // ЁЯФР User transactions (subcollection)
    match /users/{userId}/transactions/{txId} {
      // ржЗржЙржЬрж╛рж░ рж╢рзБржзрзБ ржирж┐ржЬрзЗрж░ ржЯрзНрж░рж╛ржирзНрж╕рж╛ржХрж╢ржи ржжрзЗржЦрждрзЗ/рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
      allow read, create: if request.auth != null && request.auth.uid == userId;
      // status change ржЗрждрзНржпрж╛ржжрж┐ рж╢рзБржзрзБ admin
      allow update, delete: if isAdmin();
    }

    // ЁЯФР Root-level transactions summary (ржпржжрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ)
    match /transactions/{txId} {
      allow read, write: if isAdmin();
    }

    // ЁЯМН Exchange rates тАУ ржПржЯрж╛ рж╕ржм logged-in user read ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗ
    match /exchange_rates/{rateId} {
      // Dashboard-ржП rate ржжрзЗржЦрж╛ржирзЛрж░ ржЬржирзНржп
      allow read: if request.auth != null;
      // Rates update ржХрж░ржмрзЗ рж╢рзБржзрзБ admin
      allow write: if isAdmin();
    }

    // (ржЗржЪрзНржЫрж╛ ржХрж░рж▓рзЗ ржПржХрзНрж╕ржЪрзЗржЮрзНржЬ рж▓рж┐ржорж┐ржЯрж╕ ржЗрждрзНржпрж╛ржжрж┐ржУ ржПржЦрж╛ржирзЗ ржжрж┐рждрзЗ ржкрж╛рж░рзЛ)
    // match /exchange_limits/{docId} {
    //   allow read: if request.auth != null;
    //   allow write: if isAdmin();
    // }

    // ЁЯМР ржбрж┐ржлрж▓рзНржЯ: ржмрж╛ржХрзА рж╕ржмржХрж┐ржЫрзБ рж╢рзБржзрзБ admin
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
